import Cocoa
var logs=[
    "TRANSACTIONS_MAP":[
    [
      "modified_time" : 1628286549662,
      "record_id" : nil,
      "transaction_id" : "NEW1628286549661",
      "lookup_column" : "SEID_LOOKUP",
      "table_name" : "TasksRecords_641867043",
      "lookup_id" : "NEW1628286549659",
      "lookup_label" : "SEID_LOOKUP"
    ],
    [
      "table_name" : "TasksRecords_641867043",
      "lookup_label" : "SEID_LOOKUP",
      "record_id" : nil,
      "lookup_id" : "NEW1628286549659",
      "lookup_column" : "SEID_LOOKUP",
      "modified_time" : 1628286550079,
      "transaction_id" : "NEW1628286550078"
    ],
    [
      "lookup_label" : "SEID_LOOKUP",
      "transaction_id" : "NEW1628286550076",
      "lookup_column" : "SEID_LOOKUP",
      "record_id" : nil,
      "table_name" : "TasksRecords_641867043",
      "lookup_id" : "NEW1628286549659",
      "modified_time" : 1628286550077
    ],
    [
      "lookup_id" : "NEW1628286551561",
      "table_name" : "ContactsRecords_641867043",
      "transaction_id" : "NEW1628286551565",
      "lookup_label" : "ACCOUNTID_LOOKUP",
      "record_id" : nil,
      "modified_time" : 1628286551567,
      "lookup_column" : "ACCOUNTID_LOOKUP"
    ],
    [
      "table_name" : "EventsRecords_641867043",
      "transaction_id" : "NEW1628286551568",
      "lookup_id" : "NEW1628286551561",
      "record_id" : nil,
      "lookup_label" : "SEID_LOOKUP",
      "lookup_column" : "SEID_LOOKUP",
      "modified_time" : 1628286551569
    ],
    [
      "lookup_id" : "NEW1628286551565",
      "modified_time" : 1628286551569,
      "record_id" : nil,
      "table_name" : "EventsRecords_641867043",
      "transaction_id" : "NEW1628286551568",
      "lookup_label" : "CONTACTID_LOOKUP",
      "lookup_column" : "CONTACTID_LOOKUP"
    ]
  ],
    "TRANSACTIONS" : [
    [
      "module_name" : "Accounts",
      "transaction_id" : "NEW1628286549659",
      "transaction_time" : 1628286549660,
      "error_message" : "{error=(\"crmDUPLICATE_DATA\",\"duplicatedata\");info={details={\"api_name\"=\"Account_Name\";\"duplicate_record\"={\"Account_Name\"=\"GraniteStateLunchBox\";Owner={id=2366450000004838045;name=\"LindaWilliams\";zuid=693323309;};id=2366450000006996240;};id=2366450000006996240;\"json_path\"=\"$.data[0].Account_Name\";\"more_records\"=0;};module=Accounts;servertime=1628783203274;};}",
      "operation_type" : 1
    ],
    [
      "transaction_time" : 1628286549662,
      "operation_type" : 1,
      "module_name" : "Tasks",
      "transaction_id" : "NEW1628286549661",
      "error_message" : ""
    ],
    [
      "module_name" : "Tasks",
      "operation_type" : 1,
      "transaction_time" : 1628286550079,
      "transaction_id" : "NEW1628286550078",
      "error_message" : ""
    ],
    [
      "error_message" : "",
      "module_name" : "Tasks",
      "operation_type" : 1,
      "transaction_time" : 1628286550077,
      "transaction_id" : "NEW1628286550076"
    ],
    [
      "operation_type" : 1,
      "transaction_id" : "NEW1628286550763",
      "transaction_time" : 1628286550764,
      "module_name" : "Accounts",
      "error_message" : "{error=(\"crmDUPLICATE_DATA\",\"duplicatedata\");info={details={\"api_name\"=\"Account_Name\";\"duplicate_record\"={Owner={id=2366450000000166015;name=\"SalesDepartment\";zuid=643501550;};id=2366450000006990259;};id=2366450000006990259;\"json_path\"=\"$.data[0].Account_Name\";\"more_records\"=0;};module=Accounts;servertime=1636640982773;};}"
    ],
    [
      "module_name" : "Accounts",
      "operation_type" : 1,
      "error_message" : "{error=(\"crmDUPLICATE_DATA\",\"duplicatedata\");info={details={\"api_name\"=\"Account_Name\";\"duplicate_record\"={Owner={id=2366450000037692018;name=\"RobertNorton\";zuid=749073708;};id=2366450000059074189;};id=2366450000059074189;\"json_path\"=\"$.data[0].Account_Name\";\"more_records\"=0;};module=Accounts;servertime=1657119214448;};}",
      "transaction_id" : "NEW1628286551561",
      "transaction_time" : 1628286551562
    ],
    [
      "module_name" : "Contacts",
      "transaction_id" : "NEW1628286551565",
      "error_message" : "",
      "transaction_time" : 1628286551567,
      "operation_type" : 1
    ],
    [
      "operation_type" : 1,
      "error_message" : "",
      "transaction_time" : 1628286551569,
      "transaction_id" : "NEW1628286551568",
      "module_name" : "Events"
    ],
    [
      "error_message" : "{error=(\"crmDUPLICATE_DATA\",\"duplicatedata\");info={details={\"api_name\"=\"Account_Name\";\"duplicate_record\"={Owner={id=2366450000004803110;name=\"NickJarvis\";zuid=693114560;};id=2366450000006997722;};id=2366450000006997722;\"json_path\"=\"$.data[0].Account_Name\";\"more_records\"=0;};module=Accounts;servertime=1661983345983;};}",
      "transaction_time" : 1628286552244,
      "operation_type" : 1,
      "transaction_id" : "NEW1628286552243",
      "module_name" : "Accounts"
    ],
    [
      "transaction_id" : "NEW1628286552249",
      "module_name" : "Accounts",
      "error_message" : "{error=(\"crmDUPLICATE_DATA\",\"duplicatedata\");info={details={\"api_name\"=\"Account_Name\";\"duplicate_record\"={Owner={id=2366450000000166015;name=\"SalesDepartment\";zuid=643501550;};id=2366450000062134245;};id=2366450000062134245;\"json_path\"=\"$.data[0].Account_Name\";\"more_records\"=0;};module=Accounts;servertime=1662502894689;};}",
      "transaction_time" : 1628286552250,
      "operation_type" : 1
    ],
    [
      "transaction_id" : "NEW1628286552399",
      "error_message" : "{error=(\"crmDUPLICATE_DATA\",\"duplicatedata\");info={details={\"api_name\"=\"Account_Name\";\"duplicate_record\"={Owner={id=2366450000000166015;name=\"SalesDepartment\";zuid=643501550;};id=2366450000003065168;};id=2366450000003065168;\"json_path\"=\"$.data[0].Account_Name\";\"more_records\"=0;};module=Accounts;servertime=1665087994556;};}",
      "transaction_time" : 1628286552400,
      "operation_type" : 1,
      "module_name" : "Accounts"
    ],
    [
      "module_name" : "Accounts",
      "transaction_id" : "NEW1628286552709",
      "operation_type" : 1,
      "transaction_time" : 1628286552710,
      "error_message" : "{error=(\"crmDUPLICATE_DATA\",\"duplicatedata\");info={details={\"api_name\"=\"Account_Name\";\"duplicate_record\"={Owner={id=2366450000000166015;name=\"SalesDepartment\";zuid=643501550;};id=2366450000014405182;};id=2366450000014405182;\"json_path\"=\"$.data[0].Account_Name\";\"more_records\"=0;};module=Accounts;servertime=1669406950938;};}"
    ],
    [
      "transaction_id" : "2366450000069084003",
      "error_message" : "{error=(\"crmINVALID_DATA\",\"theidgivenseemstobeinvalid\");info={details={\"api_name\"=id;\"json_path\"=\"$.data[0].id\";};module=Tasks;servertime=1654045169765;};}",
      "module_name" : "Tasks",
      "operation_type" : 2,
      "transaction_time" : 1628286551119
    ],
    [
      "module_name" : "Tasks",
      "transaction_time" : 1628286551200,
      "transaction_id" : "2366450000075309136",
      "error_message" : "{error=(\"crmINVALID_DATA\",\"theidgivenseemstobeinvalid\");info={details={\"api_name\"=id;\"json_path\"=\"$.data[0].id\";};module=Tasks;servertime=1654712609726;};}",
      "operation_type" : 2
    ]
  ]
    ]



struct Transaction : CustomStringConvertible{
    let transaction_id,module_name,transaction_time,error_message:String
    let operation_type:Int
    
    var description: String{
       return transaction_id+"\t"+module_name+"\t\t\t"+String(operation_type)+"\t\t\t\t"+transaction_time+"\t\t"+error_message
    }
    
    init(transaction_id:String,module_name:String,transaction_time:String,operation_type:Int,error_message:String){
        self.transaction_id=transaction_id
        self.module_name=module_name
        self.transaction_time=transaction_time
        self.operation_type=operation_type
        self.error_message=error_message
    }
    
    enum Sort{
        case transaction_id,module_name,transaction_time,operation_type,error_message
    }
}


struct TransactionMap: CustomStringConvertible{
    let transaction_id,lookup_id,lookup_column,lookup_label,table_name,modified_time:String
    let record_id:String?
    
    init(transaction_id:String,lookup_id:String,lookup_column:String,
         lookup_label:String,record_id:String?,table_name:String,modified_time:String) {
        self.transaction_id=transaction_id
        self.lookup_id=lookup_id
        self.lookup_column=lookup_column
        self.lookup_label=lookup_label
        self.record_id=record_id
        self.table_name=table_name
        self.modified_time=modified_time
    }
    
    var description: String{
            return transaction_id+"\t"+lookup_id+"\t"+lookup_column+"\t\t"+lookup_label+"\t\t\t"+(record_id ?? "-")+"\t\t"+table_name+"\t\t"+modified_time
    }
    
    enum Sort{
        case TRANSACTION_ID,LOOKUP_ID,LOOKUP_COLUMN,LOOKUP_LABEL,RECORD_ID,TABLE_NAME,MODIFIED_TIME
    }
}


struct Logs{
    
    var transactionMap=[TransactionMap]()
    var transactions=[Transaction]()
    
    init(logs :[String:[[String:Any?]]]) {
        self.transactionMap=create(array:logs["TRANSACTIONS_MAP"]!, operation:OperationForTransactionMap)
        self.transactions=create(array:logs["TRANSACTIONS"]! , operation:OperationForTransaction)
    }
    
    private var OperationForTransactionMap:([String:Any])->AnyObject={ transactionMap in
         let id=transactionMap["transaction_id"] as! String
         let l_id=transactionMap["lookup_id"] as! String
         let l_column=transactionMap["lookup_column"] as! String
         let l_label=transactionMap["lookup_label"] as! String
         let record=transactionMap["record_id"] ?? "-"
         let table=transactionMap["table_name"] as! String
         let time={
             let date = Date(timeIntervalSince1970:Double(transactionMap["modified_time"] as! Int) / 1000.0)

             let formatter = DateFormatter()
             formatter.dateStyle = .medium
             formatter.timeStyle = .medium
             return formatter.string(from: date)
         }
         return TransactionMap(transaction_id: id, lookup_id: l_id, lookup_column: l_column, lookup_label: l_label, record_id: record as? String  , table_name: table, modified_time: time()) as AnyObject
     }
    
    private func OperationForTransaction(transaction:[String:Any])->AnyObject{
        let id=transaction["transaction_id"] as! String
        let name=transaction["module_name"] as! String
        
        let time={
            let date = Date(timeIntervalSince1970:Double(transaction["transaction_time"] as! Int) / 1000.0)

            let formatter = DateFormatter()
            formatter.dateStyle = .medium
            formatter.timeStyle = .medium
            return formatter.string(from: date)
        }
        
        let op=transaction["operation_type"] as! Int
        let msg=transaction["error_message"] as! String
       var error:(String)->String={ value in
           if(value==""){
               for trans in transactionMap{
                   if(trans.transaction_id==id){
                       return "Account-\(trans.lookup_id) - is the Parent"
                   }
               }
               return "-"
           }
           else{
               return String(value[value.firstIndex(of: "\"")!..<value.firstIndex(of: ",")!]).replacing("\"", with: "")
           }
           
       }
        
        return Transaction(transaction_id: id, module_name: name, transaction_time:time(), operation_type: op, error_message:error(msg)) as AnyObject
    }
    
    
    mutating func create<T>(array:[[String:Any?]],operation:([String:Any?])->AnyObject)->[T]{
        
        var transactions=[T]()
        
            for transaction in array{
                let item=operation(transaction)
                if( item is T){
                    transactions.append(item as! T)
                }
            }
            return transactions
        
    }
    
    func details(){
        var transaction="S.NO\tTRANSACTION ID\tMODULE NAME\t\tOPERATION TYPE\tTRANSACTION TIME\t\t\tERROR"
        var transactionMap="S.NO\tTRANSACTION_ID\tLOOKUP_ID\t\t\tLOOKUP_COLUMN\tLOOKUP_LABEL\tRECORD_ID\tTABLE_NAME\tMODIFIED_TIME"
        
        func output<T>(text:String ,array:[T]){
            print(text)
            for i in 0..<array.count{
                print("\(i+1)\t\(array[i])")
            }
        }
        print("\nTRANSACTION\n")
        output(text: transaction, array:self.transactions)
        print("\nTRANSACTION-MAP\n")
        output(text: transactionMap, array: self.transactionMap)
    }
    
   mutating func sortTransactions(by type:Transaction.Sort){
        switch type{
        case .transaction_id:
            transactions.sort(by: {$0.transaction_id<$1.transaction_id})
        case .module_name:
            transactions.sort(by: {$0.module_name<$1.module_name})
        case .transaction_time:
            transactions.sort(by: {$0.transaction_time<$1.transaction_time})
        case .operation_type:
            transactions.sort(by: {$0.operation_type<$1.operation_type})
        case .error_message:
            transactions.sort(by: {$0.error_message<$1.error_message})
        }
    }
    
   mutating func sortTransactionMap(by type:TransactionMap.Sort){
        switch type{
        case .TRANSACTION_ID:
            transactionMap.sort(by:{ $0.transaction_id<$1.transaction_id})
        case .LOOKUP_ID:
            transactionMap.sort(by: {$0.lookup_id<$1.lookup_id})
        case .LOOKUP_COLUMN:
            transactionMap.sort(by: {$0.lookup_column<$1.lookup_column})
        case .LOOKUP_LABEL:
            transactionMap.sort(by: {$0.lookup_label<$1.lookup_label})
        case .RECORD_ID:
            transactionMap.sort(by: {$0.record_id!<$1.record_id!})
        case .TABLE_NAME:
            transactionMap.sort(by: {$0.table_name<$1.table_name})
        case .MODIFIED_TIME:
            transactionMap.sort(by: {$0.modified_time<$1.modified_time})
        }
    }
    
}

var log=Logs(logs:logs)
log.sortTransactions(by: .module_name)
log.sortTransactionMap(by: .TABLE_NAME)
log.details()


